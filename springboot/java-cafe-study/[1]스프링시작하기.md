# 스프링 시작하기

### 학습 목표

- 스프링 부트로 간단하게 스프링 애플리케이션을 개발하는 방법을 안다
- 스프링 부트의 핵심 기능을 안다
- 스프링 부트 개발 환경 설정하는 방법을 안다



# 1.1 스프링의 새로운 시작

  스프링은 JEE나 J2EE로 알려진 자바 엔터프라이즈 에디션을 경량화하는 대안으로 시작되었다. 스프링은 의존성 주입과 관점 지향 프로그래밍 (AOP)을 활용해서 EJB의 기능을 평범한 자바 객체 (POJO)로 구현할 수 있게 하여 간단하게 엔터프라이즈 자바 개발에 접근할 수 있는 방법을 제공했다. 그러나, 복잡한 개발 구성이 단점이었다. 그 예시로, 트랜잭션 관리와 스프링 MVC 같은 기능을 사용하려면 명시적인 XML이나 자바 구성이 필요했다. 이렇게, 애플리케이션 로직 작성 대신 구성 작업에 쓰는 시간이 더 많아지고, 의존성 관리가 힘들었다.

## 1.1.1 스프링의 새로운 모습 살펴보기

  스프링으로 아주 간단한 `Hello World` 웹 애플리케이션을 개발한다고 하자. 최소한 아래 적힌 항목이 필요하다

- 필요한 의존성을 비롯한 메이븐이나 그레이들 빌드 파일이 완비된 프로젝트 구조
  - 적어도 스프링 MVC와 서블릿 API를 의존성으로 지정해야 한다
- 스프링의 DispatcherServlet을 선언한 `web.xml` 파일 또는 `WebApplicationInitializer` 구현
- 스프링 MVC를 사용할 수 있는 스프링 구성
- HTTP 요청에 `"Hello World"` 라고 응답할 컨트롤러 클래스
- 애플리케이션을 배포할 웹 애플리케이션 서버 (톰캣 등)

  위 항목들에서 실질적으로 `Hello World` 기능을 개발하는 데 필요한 것은 `HelloWorldController` 뿐이다. 나머지 항목들은 스프링으로 웹 애플리케이션을 개발할 때 필요한 일반적인 보일러플레이트다. 이렇게, 모든 스프링 웹 애플리케이션에 이런 것들이 필요하다면 왜 개발자가 항상 별도로 준비해야 할까?

## 1.1.2 스프링 부트의 핵심 살펴보기

  스프링 부트의 핵심은 4가지로 말할 수 있다.

1. 자동 구성
2. 스타터 의존성
3. 명령줄 인터페이스
4. 액추에이터

위 4가지의 기능들이 각각 무엇을 제공하는지 알아보자.

### 1. 자동 구성

  어떤 스프링 애플리케이션의 소스 코드에서든 애플리케이션의 특정한 지원 특징과 기능을 활성화하는 자바 구성이나 XML 구성을 볼 수 있다. 예를 들어, JDBC로 관계형 데이터베이스에 접속하는 애플리케이션을 작성했다면, 아마 스프링 애플리케이션 컨텍스트에 스프링의 `JdbcTemplate` 을 Bean으로 구성했을 것이다. 아래와 같이 말이다.

```java
@Bean
public JdbcTemplate jdbcTemplate(DateSource dataSource) {
		return new JdbcTemplate(dataSource);
}
```

- Bean 선언으로 `JdbcTemplate` 인스턴스를 생성하여 `DataSource` 의존성을 주입한다. 이 의존성을 만족하도록 `DataSource` Bean을 구성해야 한다는 의미이다. 아래처럼 말이다.

```java
@Bean
public DataSource dataSource() {
		return new EmbeddedDatabaseBuilder()
								.setType(EmbeddedDatabaseType.H2)
								.addScripts('schema.sql', 'data.sql')
								.build();
}
```

- Bean 구성 메소드는 h2 데이터베이스를 생성하고 h2 데이터베이스에서 실행할 SQL 스크립트 (`schema.sql`, `data.sql`) 를 지정한다.
- `build()` 메소드는 h2 데이터베이스를 참조하는 `DataSource` 를 반환한다.

  이렇게, 스프링에서는 일일이 보일러플레이트 구성을 작성해줘야한다. 이런 일이 흔하게 일어난다면 일일이 구성을 작성해줘야할까?

  여기서 스프링 부트의 장점 및 핵심이 대두된다. 스프링 부트는 이런 공통 구성 시나리오를 자동으로 구성할 수 있다. 예를 들어, 스프링 부트가 애플리케이션 클래스패스에서 H2 데이터베이스 라이브러리를 발견한다면 내장 H2 데이터베이스를 자동으로 구성할 것이다. `JdbcTemplate` 이 클래스패스에 있다면 `JdbcTemplate` Bean도 구성할 것이다. 이렇게 스프링 부트가 Bean을 자동으로 구성하여 개발자가 작성한 Bean에 주입 (Inject) 할 준비를 해준다.

  스프링 부트에는 h2 데이터베이스, JdbcTemplate 뿐만 아니라 JPA, Thymeleaf, Security 등 여러 자동 구성을 포함하고 있다.



### 2. 스타터 의존성

  프로젝트의 빌드에 의존성을 추가하기가 쉽지 않다. 어떤 라이브러리가 필요한가? 라이브러리 그룹과 아티팩트는 무엇인가? 어떤 버전이 필요한가? 이 버전은 프로젝트에 있는 다른 의존 라이브러리와 잘 작동할까?

  스프링 부트는 스타터 의존성 수단으로 프로젝트 의존성을 쉽게 관리한다. 스타터 의존성은 몇 가지 기능 정의 의존성에 따라 전이적 의존성 (Transitive Dependency) 해결 방법을 이용하여 공통으로 사용하는 라이브러리들을 모으는 조금은 특별한 메이븐 (또는 그레이들) 의존성일 뿐이다. 

  예를 들어, JSON 형식의 리소스를 다루는 REST API를 스프링 MVC로 만든다고 해보자. 추가로 JSR-303 명세에 따라 선언적 유효성 검사를 적용하고 내장 톰캣 서버로 애플리케이션을 구동하려 한다. 이렇게 하려면 메이븐이나 그레이들 빌드에 최소한 의존성을 아래와 같이 추가해야 한다.

- org.springframework:spring-core
- org.springframework:spring-web
- org.springframework:spring-webmvc
- com.fasterxml.jackson.core:jackson-databind
- org.hibernate:hibernate-validator
- org.apache.tomcat.embed:tomcat-embed-core
- org.apache.tomcat.embed:tomcat-embed-el
- org.apache.tomcat.embed:tomcat-embed-logging-juli



  반면에, 스프링 부트의 스타터 의존성을 사용하면 `org.springframework.boot:spring-boot-starter-web` 을 추가하면된다. 이렇게, 스타터 의존성 하나만 추가하면 다른 의존성을 전이적으로 끌어오므로 의존성 전체를 일일이 추가할 필요가 없다.

  나아가서, 스타터 의존성은 단순히 빌드 의존성 개수를 줄이는 것보다 더 정교한 일을 한다. 특정 기능을 지원하려면 어떤 라이브러리를 사용해야 하는지 더는 생각할 필요가 없다. 그저 해당 기능에 적절한 스타터 의존성을 찾아서 요청하면 된다. 또한, 스프링 부트의 스타터 의존성을 사용하면 필요한 라이브러리의 버전을 고민할 필요가 없다. 스타터가 끌어오는 라이브러리 버전은 이미 테스트를 거쳐 라이브러리 간에 호환성 문제가 없다고 확인했기 때문이다.



### 3. 명령줄 인터페이스 (CLI)

  스프링 부트 CLI는 개발자가 코드 작성에만 집중할 수 있도록 스타터 의존성과 자동 구성을 활용한다. 스프링 부트 CLI가 어떤 타입을 사용했는지 발견하여 이 타입이 작동할 수 있게 클래스패스에 알맞은 스타터 의존성을 추가한다. 이 의존성이 클래스패스에 있으면 일련의 자동 구성이 일어나서 HTTP 요청에 컨트롤러가 응답할 수 있도록 `DispatcherServlet` 과 `Spring MVC`를 활성화한다.



### 4. 액추에이터 (Actuator)

  액추에이터는 작동 중인 애플리케이션의 내부를 살펴볼 수 있는 기능을 제공한다. 액추에이터를 설치했다면 다음과 같은 애플리케이션의 내부 작동을 살펴볼 수 있다.

- 스프링 애플리케이션 컨텍스트에 구성된 Bean
- 스프링 부트의 자동 구성으로 구성된 것
- 애플리케이션에서 사용할 수 있는 환경 변수, 시스템 프로퍼티, 구성 프로퍼티, 명령줄 인자
- 애플리케이션에서 구동중인 스레드의 현재 상태
- 최근에 처리된 HTTP 요청 정보
- 메모리 사용량, 가비지 컬렉션, 웹 요청, 데이터 소스 사용량 등 다양한 메트릭

  액추에이터는 이 정보를 웹 엔드포인트와 shell 인터페이스를 사용하여 보여준다.



## 1.1.3 스프링 부트가 받는 오해

- 스프링 부트는 애플리케이션 서버가 아니다
  - 스프링 부트는 전통적인 자바 애플리케이션 서버에 배포하지 않고도 명령줄에서 실행할 수 있는 JAR 파일로 웹 애플리케이션을 개발할 수 있는데, 이는 스프링 부트가 애플리케이션에 Tomct, Jetty, Undertow 같은 서블릿 컨테이너를 내장하기 때문에 웹 애플리케이션 서버를 쓸 수 있는 것이다.
  - 애플리케이션 서버 기능은 내장 서블릿 컨테이너가 제공하는 것이지, 스프링 부트 자체가 제공하는 기능은 아니다
- 스프링 부트는 JPA나 JMS 같은 엔터프라이즈 자바 명세를 일절 구현하지 않는다
  - 스프링 부트가 엔터프라이즈 기능을 지원하는 빈들을 자동으로 스프링에 구성하기 때문에 엔터프라이즈 자바 명세를 몇 가지 지원하기는 한다. 
  - 예를 들어, 스프링 부트는 JPA를 구현하지 않지만 Hibernate 같은 JPA 구현체에 대응하는 빈을 알맞게 자동 구성하여 JPA를 지원한다.
- 스프링 부트는 자동 구성을 하려고 어떤 형태의 코드도 생성하지 않는다
  -  그 대신 스프링 4.0에서 제공하는 조건부 구성 기능과 메이븐이나 그레이들이 제공하는 전이적 의존성 해결 기능을 활용하여 스프링 애플리케이션 컨텍스트에 자동으로 빈을 구성한다
- 스프링 부트도 본질적으로는 스프링이다
  - 내부에 스프링 부트가 없었을 때 스프링에 빈을 구성했듯이 스프링 부트가 동일한 작업을 할 뿐이다.
  - 스프링 부트는 보일러플레이트 구성을 자유롭게 해주는 것이다.



# 1.2 스프링 부트 시작하기

## 1.2.1 스프링 부트 CLI 설치

  여러 가지 방법들이 있지만, Homebrew로 설치하는 방법을 알아보자. Mac OS (OS X)를 이용한다면 Homebrew로 스프링 부트 CLI를 설치할 수 있다. Homebrew는 OS X용 패키지 매니저로 많은 애플리케이션과 도구를 설치할 때 사용한다.

1. Homebrew 설치

```bash
$ ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```

2. Pivotal 탭 태핑 (Homebrew에 Pivotal 탭 추가)

```bash
$ brew tap pivotal/tap
```

3. springboot CLI 설치 (Homebrew는 `/usr/local/bin` 디렉터리에 스프링 부트 CLI를 설치하므로 바로 사용 가능)

```bash
$ brew install springboot
```

4. 설치된 springboot 버전 체크 

```bash
$ spring --version
```



### 명령 자동 완성 활성화

  스프링 부트 CLI는 CLI 기반의 애플리케이션을 실행, 패키징, 테스팅할 수 있는 유용한 명령을 제공한다. 각 명령에는 여러 옵션이 있다. CLI가 제공하는 명령들의 명령 자동 완성 기능을 활성화해보자. Homebrew로 CLI를 설치했다면 이미 명령 자동 완성 스크립트는 설치가 되어 있다.

  명령 자동 완성 스크립트는 스프링 부트 CLI 설치 디렉터리 아래에 있는 `shell-completion` 디렉터리에 들어있다. bash에서 명령 자동 완성 스크립트를 적용하려면 다음 명령을 실행한다

```bash
$ . ~/.sdkman/candidates/springboot/current/shell-completion/bash/spring
```

- 이 명령은 현재 shell에만 스프링 부트 CLI 자동 완성 기능을 적용한다. 따라서, 새로운 shell을 시작할 때마다 명령 자동 완성 스크립트를 다시 적용해야 자동 완성 기능을 사용할 수 있다.



## 1.2.2 Spring Initializer로 스프링 부트 프로젝트 구성하기

  `Spring Initializer` 는 스프링 부트 프로젝트 구조를 만드는 웹 애플리케이션이다. 물론 애플리케이션 코드를 생성하는 것은 아니지만, 기본적인 프로젝트 구조와 코드를 빌드하는 데 필요한 메이븐이나 그레이들 빌드 명세는 만든다. 따라서, 개발자는 `Spring Initializer` 가 만든 프로젝트에 애플리케이션 코드만 작성하면 된다. 

`Spring Initializer` 를 사용하는 방법은 아래와 같이 여러가지 방법들이 있지만, http://start.spring.io와 IntelliJ IDEA를 이용하여 `Spring Initializer` 를 사용하는 방법을 알아보자.

- 웹 기반 인터페이스 (http://start.spring.io)
- Spring Tool Suite (STS)
- IntelliJ IDEA
- Springboot CLI

### 1. http://start.spring.io 사용

![image-20210520203258506](images/image-20210520203258506.png)

- 프로젝트를 메이븐이나 그레이들 중 어떤 방식을 이용하여 빌드할지 선택
- 스프링 부트의 버전 선택
- 프로젝트의 메타데이터 지정
  - 프로젝트 그룹
  - 프로젝트 아티팩트
- 프로젝트 의존성 지정
- 이후 `Generate Project` 를 하면 된다

<img src="images/image-20210520204121629.png" alt="image-20210520204121629" style="zoom:33%;" />

#### 만들어진 Project Structure

- `build.gradle` : gradle 빌드 명세, maven을 선택했다면, `pom.xml` 로 대체된다
- `gradlew` : gradle wrapper, 시스템에 그레이들을 설치하지 않았으면 `gradle` 명령 대신에 이 스크립트 (Windows 에서는 배치 파일 `gradle.bat`) 를 사용한다
- `DemoApplication.java` : 애플리ㅔ이션을 시작하는 `main()` 메소드가 있는 클래스
- `application.properties` : 필요한 구성 프로퍼티를 추가하는 빈 프로퍼티 파일
- `DemoApplcationTests.java` : 스프링 부트 자동 구성을 이용하여 스프링 애플리케이션 컨텍스트를 로드하도록 구성한 빈 JUnit 테스트 클래스
- `static` 디렉토리 : 웹 애플리케이션에서 제공할 자바스크립트, 스타일시트, 이미지를 비롯한 여러 정적 콘텐츠를 넣을 수 있음
- `templates` 디렉토리 : 모델 데이터를 렌더링할 템플릿을 넣을 수 있음



## 1.3 요약

  스프링 부트는 프레임워크 자체에 저항을 최소화하면서 스프링 애플리케이션을 개발할 수 있는 방법이다. 자동 구성은 전통적인 스프링 애플리케이션에 있던 많은 보일러플레이트 구성을 제거했다. 스프링 부트 스타터는 명시적인 라이브러리 이름이나 버전 대신에 스프링 부트가 제공하는 기능으로 빌드 의존성을 지정할 수 있게 했다. 스프링 부트 CLI는 명령줄에서 그루비를 사용하여 빠르고 간편하게 개발할 수 있게 하여 스프링 부트의 저항 없는 개발 모델을 완전히 새로운 수준으로 끌어올렸다. 그리고 액추에이터는 작동 중인 애플맄이션 내부를 살펴보면서 스프링 부트가 어떤 식으로 처리하는지 알 수 있게 했다.



## Reference

- 크레이그 월즈, 『스프링 부트 코딩 공작소』, 길벗(2016), p.21 ~ p.45