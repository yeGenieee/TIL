# 2023-06-01

### ðŸ“Œ í•™ìŠµ ê³„íš
- GCì˜ ì—­ì‚¬
- ë‚´ê°€ ì‚¬ìš©í•˜ëŠ” java ë²„ì „ì˜ default GC
- G1 GC 
- Z GC

### âœï¸ TIL
- Stop-the-world
- GCì˜ ì—­ì‚¬
- ë‚´ê°€ ì‚¬ìš©í•˜ëŠ” java ë²„ì „ì˜ default GC
- G1 GC
- Z GC

## Stop-the-world
- GCë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ JVMì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì„ ë©ˆì¶”ëŠ” ê²ƒ
- `stop-the-world` ë°œìƒ ì‹œ, GCë¥¼ ì‹¤í–‰í•˜ëŠ” ì“°ë ˆë“œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì“°ë ˆë“œëŠ” ëª¨ë‘ ìž‘ì—…ì„ ë©ˆì¶˜ë‹¤
- GC ìž‘ì—…ì„ ì™„ë£Œí•œ ì´í›„ì—ì•¼ ì¤‘ë‹¨í–ˆë˜ ìž‘ì—…ì„ ë‹¤ì‹œ ì‹œìž‘í•œë‹¤
- ì–´ë–¤ GC ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ë”ë¼ë„ `stop-the-world` ëŠ” ë°œìƒí•œë‹¤
  - GC íŠœë‹ : `stop-the-world` ì‹œê°„ ì¤„ì´ëŠ” ê²ƒì´ í•µì‹¬! 

## Garbage Collector ì˜ ê°€ì„¤ (ì „ì œ ì¡°ê±´) : `weak generational hypothesis`
1. ëŒ€ë¶€ë¶„ì˜ ê°ì²´ëŠ” ê¸ˆë°© ì ‘ê·¼ ë¶ˆê°€ëŠ¥ ìƒíƒœ(unreachable)ê°€ ëœë‹¤
2. ì˜¤ëž˜ëœ ê°ì²´ì—ì„œ ì Šì€ ê°ì²´ë¡œì˜ ì°¸ì¡°ëŠ” ì•„ì£¼ ì ê²Œ ì¡´ìž¬í•œë‹¤

- ê°€ì„¤ì˜ ìž¥ì ì„ ìµœëŒ€í•œ ì‚´ë¦¬ê¸° ìœ„í•´ HotSpot VMì—ì„œëŠ” Heap ì˜ì—­ì„ í¬ê²Œ 2ê°œì˜ ë¬¼ë¦¬ì  ê³µê°„ì„ ë‚˜ëˆ„ì—ˆë‹¤
  1. `Young` ì˜ì—­
     - ìƒˆë¡­ê²Œ ìƒì„±í•œ ê°ì²´ì˜ ëŒ€ë¶€ë¶„ì´ ì—¬ê¸°ì— ìœ„ì¹˜í•œë‹¤
     - ëŒ€ë¶€ë¶„ì˜ ê°ì²´ê°€ ê¸ˆë°© unreachableì´ ë˜ê¸°ì— ë§Žì€ ê°ì²´ë“¤ì´ Young ì˜ì—­ì— ìƒì„±ë˜ì—ˆë‹¤ê°€ ì‚¬ë¼ì§„ë‹¤
     - ì´ ì˜ì—­ì—ì„œ ê°ì²´ê°€ ì‚¬ë¼ì§ˆ ë•Œ : `Minor GC`
  2. `Old` ì˜ì—­
     - unreachable ìƒíƒœê°€ ë˜ì§€ ì•Šì•„ Young ì˜ì—­ì—ì„œ ì‚´ì•„ ë‚¨ì€ ê°ì²´ê°€ ë³µì‚¬ë˜ëŠ” ì˜ì—­ì´ë‹¤
     - ëŒ€ë¶€ë¶„ Young ì˜ì—­ë³´ë‹¤ í¬ê²Œ í• ë‹¹í•œë‹¤
     - í¬ê¸°ê°€ í° ë§Œí¼ Young ì˜ì—­ë³´ë‹¤ GCëŠ” ì ê²Œ ë°œìƒí•œë‹¤
     - ì´ ì˜ì—­ì—ì„œ ê°ì²´ê°€ ì‚¬ë¼ì§ˆ ë•Œ : `Major GC`, `Full GC`

> Old ì˜ì—­ì— ìžˆëŠ” ê°ì²´ê°€ Young ì˜ì—­ì˜ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ëŠ”ê°€?
> - Old ì˜ì—­ ë‚´ì— 512 byteì— í•´ë‹¹í•˜ëŠ” ì¹´ë“œ í…Œì´ë¸” (card table) ì´ ìžˆë‹¤
> - Old ì˜ì—­ì— ìžˆëŠ” ê°ì²´ê°€ Young ì˜ì—­ì˜ ê°ì²´ë¥¼ ì°¸ì¡°í•  ë•Œ ë§ˆë‹¤ ì •ë³´ê°€ í‘œì‹œëœë‹¤
> - Young ì˜ì—­ì˜ GCë¥¼ ì‹¤í–‰í•  ë•ŒëŠ” Old ì˜ì—­ì— ìžˆëŠ” ëª¨ë“  ê°ì²´ì˜ ì°¸ì¡°ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì¹´ë“œ í…Œì´ë¸”ë§Œ ë’¤ì ¸ì„œ GC ëŒ€ìƒì¸ì§€ ì‹ë³„í•œë‹¤

## Young ì˜ì—­ì˜ êµ¬ì„±
1. Eden ì˜ì—­
2. Survivor 1
3. Survivor 2

- ê° ì˜ì—­ì˜ ì²˜ë¦¬ ì ˆì°¨ëŠ” ì•„ëž˜ì™€ ê°™ë‹¤
1. ìƒˆë¡œ ìƒì„±í•œ ëŒ€ë¶€ë¶„ì˜ ê°ì²´ëŠ” `Eden` ì˜ì—­ì— ìœ„ì¹˜í•œë‹¤
2. `Eden` ì˜ì—­ì—ì„œ GCê°€ í•œ ë²ˆ ë°œìƒí•œ í›„ ì‚´ì•„ë‚¨ì€ ê°ì²´ëŠ” `Survivor` ì˜ì—­ ì¤‘ í•˜ë‚˜ë¡œ ì´ë™í•œë‹¤
3. `Eden` ì˜ì—­ì—ì„œ GCê°€ ë°œìƒí•˜ë©´ ì´ë¯¸ ì‚´ì•„ë‚¨ì€ ê°ì²´ê°€ ì¡´ìž¬í•˜ëŠ” `Survivor` ì˜ì—­ìœ¼ë¡œ ê°ì²´ê°€ ê³„ì† ìŒ“ì¸ë‹¤
4. í•˜ë‚˜ì˜ `Survivor` ì˜ì—­ì´ ê°€ë“ ì°¨ê²Œ ë˜ë©´ ê·¸ ì¤‘ ì‚´ì•„ë‚¨ì€ ê°ì²´ë¥¼ ë‹¤ë¥¸ `Survivor` ì˜ì—­ìœ¼ë¡œ ì´ë™í•œë‹¤ (ê°€ë“ ì°¬ `Survivor` ì˜ì—­ì€ ì•„ë¬´ ë°ì´í„°ë„ ì—†ëŠ” ìƒíƒœë¡œ ë‘ê²Œ ëœë‹¤)
5. ì´ ê³¼ì •ì„ ë°˜ë³µí•˜ë‹¤ê°€ ê³„ì†í•´ì„œ ì‚´ì•„ë‚¨ì€ ê°ì²´ëŠ” `Old` ì˜ì—­ìœ¼ë¡œ ì´ë™í•˜ê²Œ ëœë‹¤

- `Survivor` ì˜ì—­ ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ë¹„ì–´ìžˆëŠ” ìƒíƒœë¡œ ë‚¨ì•„ ìžˆì–´ì•¼ í•œë‹¤!

## Old ì˜ì—­ì˜ êµ¬ì„±
- Minor GCë§Œ ì¡´ìž¬í•œë‹¤ë©´, Old ì˜ì—­ì˜ ìš©ëŸ‰ì€ í•­ìƒ ëŠ˜ì–´ë‚˜ê²Œ ë˜ì–´, ì–¸ì  ê°€ëŠ” í•œê³„ê°€ ì˜¤ê²Œ ëœë‹¤
- ê·¸ëž˜ì„œ Old ì˜ì—­ì— ë°ì´í„°ê°€ ê°€ë“ì°¨ë©´ GCë¥¼ ì‹¤í–‰í•œë‹¤
- Old ì˜ì—­ì— í• ë‹¹ì´ ì‹¤íŒ¨í•œ ì‹œì ì— Full GCê°€ ë°œìƒí•˜ê³ , Old ì˜ì—­ê³¼ Young ì˜ì—­ ëª¨ë‘ ë©”ëª¨ë¦¬ë¥¼ ì²­ì†Œí•˜ê²Œ ëœë‹¤

## GCì˜ ì—­ì‚¬
- Java 6 ì´ì „
  - Serial GC, Parallel GC, CMS GC
- Java 7
  - G1 GC ì¶”ê°€
- Java 8
  - Serial GC, Parallel GCê°€ ê¸°ë³¸ê°’
- Java 9
  - G1 GCê°€ ê¸°ë³¸ê°’

## GC êµ¬í˜„ ë°©ì‹
- GC ë°©ì‹ì— ë”°ë¼ ì²˜ë¦¬ ì ˆì°¨ê°€ ë‹¬ë¼ì§„ë‹¤ 
  1. Serial GC
  2. Parallel GC
  3. Parallel Old GC (Parallel Compacting GC)
  4. Concurrent Mark & Sweep GC
  5. G1 (Garbage First) GC
  6. Z GC

## Serial GC
- ë°ìŠ¤í¬í†±ì˜ CPU ì½”ì–´ê°€ í•˜ë‚˜ë§Œ ìžˆì„ ë•Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë§Œë“  ë°©ì‹ì´ë¼, Serial GCë¥¼ ì‚¬ìš©í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ì´ ë§Žì´ ë–¨ì–´ì§„ë‹¤ (ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ëŒì•„ê°)
- ìš´ì˜ ì„œë²„ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤
- ì ì€ ë©”ëª¨ë¦¬ì™€ CPU ì½”ì–´ ê°œìˆ˜ê°€ ì‚¬ìš©í•  ë•Œë§Œ ì í•©í•œ ë°©ì‹ì´ë‹¤
- Old ì˜ì—­ì˜ GCëŠ” `mark-sweep-compact` ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œë‹¤
1. Mark : Old ì˜ì—­ì— ì‚´ì•„ ìžˆëŠ” ê°ì²´ ì‹ë³„
2. Sweep : Heapì˜ ì•ž ë¶€ë¶„ë¶€í„° í™•ì¸í•´ì„œ ì‚´ì•„ ìžˆëŠ” ê°ì²´ë§Œ ë‚¨ê¸´ë‹¤
3. Compact : ê° ê°ì²´ë“¤ì´ ì—°ì†ë˜ê²Œ ìŒ“ì´ë„ë¡ íž™ì˜ ê°€ìž¥ ì•ž ë¶€ë¶„ë¶€í„° ì±„ì›Œì„œ ê°ì²´ê°€ ì¡´ìž¬í•˜ëŠ” ë¶€ë¶„ / ì—†ëŠ” ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆˆë‹¤

- **STW ë°œìƒ ì‹œê°„ì´ ê¸¸ë‹¤**

## Parallel GC
- Serial GCì™€ ê¸°ë³¸ì ì¸ ì•Œê³ ë¦¬ì¦˜ì€ ê°™ë‹¤
- Parallel GCëŠ” GC ì²˜ë¦¬ ì“°ë ˆë“œê°€ ì—¬ëŸ¬ ê°œì—¬ì„œ Serial GCë³´ë‹¤ ë¹ ë¥´ê²Œ ê°ì²´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìžˆë‹¤
- ë©”ëª¨ë¦¬ê°€ ì¶©ë¶„í•˜ê³  ì½”ì–´ì˜ ê°œìˆ˜ê°€ ë§Žì„ ë•Œ ìœ ë¦¬í•˜ë‹¤ (ë©€í‹° ì½”ì–´)
- Java 8ì˜ default GC

- **STW ì‹œê°„ì´ Serial GCë³´ë‹¤ëŠ” ì§§ë‹¤**

## Parallel Old GC
- Old ì˜ì—­ì˜ GC ì•Œê³ ë¦¬ì¦˜ì´ `Mark-Summary-Compaction` ì´ë‹¤

## CMS GC (Concurrent Mark & Sweep)
- GC ìž‘ì—…ì„ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ì“°ë ˆë“œì™€ ë„ì‹œì— ìˆ˜í–‰í•˜ì—¬ GCë¡œ ì¸í•œ STWë¥¼ ìµœì†Œí™”í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤ !!
- ë‹¤ë¥¸ GC ë°©ì‹ë³´ë‹¤ ë©”ëª¨ë¦¬ì™€ CPUë¥¼ ë” ë§Žì´ ì‚¬ìš©í•œë‹¤
- Compactionì„ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ì§€ ì•Šì•„ì„œ ë©”ëª¨ë¦¬ë¥¼ ë” ë§Žì´ ì°¨ì§€í•˜ê²Œ ëœë‹¤
- Compaction ìž‘ì—… ìˆ˜í–‰ ì‹œ ë‹¤ë¥¸ GC ë°©ì‹ë³´ë‹¤ STW ì‹œê°„ì´ ë” ê¸¸ì–´ì„œ, Compaction ìž‘ì—…ì´ ì–¼ë§ˆë‚˜ ìžì£¼, ì˜¤ëž«ë™ì•ˆ ìˆ˜í–‰ë˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤
- G1 GC ë“±ìž¥ì— ë”°ë¼ Deprecated

## G1 GC
- Heap ì˜ì—­ì„ **Region** ì´ë¼ëŠ” ë…¼ë¦¬ì  ë‹¨ìœ„ë¡œ êµ¬ë¶„í•˜ì—¬ ê° ì˜ì—­ì— ê°ì²´ë¥¼ í• ë‹¹í•˜ê³  GCë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ë‹¤
  - ê° Regionì€ 1MB ~ 32MB ì‚¬ì´ë¡œ ì§€ì •ë  ìˆ˜ ìžˆë‹¤
  - Humongous : Region í¬ê¸°ì˜ 50%ë¥¼ ì´ˆê³¼í•˜ëŠ” í° ê°ì²´ë¥¼ ì €ìž¥í•˜ê¸° ìœ„í•œ ê³µê°„ìœ¼ë¡œ, í•´ë‹¹ Region ì—ì„œëŠ” GC ë™ìž‘ì´ ìµœì ìœ¼ë¡œ ë™ìž‘í•˜ì§€ ì•ŠëŠ”ë‹¤
  - Available / Unused : ì•„ì§ ì‚¬ìš©ë˜ì§€ ì•Šì€ Regionì„ ì˜ë¯¸í•œë‹¤
- í•´ë‹¹ ì˜ì—­ì´ ê½‰ ì°¨ë©´ ë‹¤ë¥¸ ì˜ì—­ì—ì„œ ê°ì²´ë¥¼ í• ë‹¹í•˜ê³  GCë¥¼ ì‹¤í–‰í•œë‹¤
- Young -> Old ê³¼ì •ì´ ì‚¬ë¼ì§„ GC ë°©ì‹ì´ë‹¤
- CMS GCë¥¼ ëŒ€ì²´í•˜ê¸° ìœ„í•´ ê³ ì•ˆë˜ì—ˆë‹¤
- ì„±ëŠ¥ì´ ì¢‹ë‹¤
- **STW** ìµœì†Œí™”
- Java 9ë¶€í„° default GC

### ìž¥ì 
- ë³„ë„ì˜ STWì—†ì´ë„ ì—¬ìœ  ë©”ëª¨ë¦¬ ê³µê°„ì„ compact
- Heap í¬ê¸°ê°€ í´ìˆ˜ë¡ ìž˜ ë™ìž‘í•œë‹¤
- ì²˜ë¦¬ ì†ë„ê°€ ë¹ ë¥´ë‹¤
- Garbageë¡œ ê°€ë“ì°¬ ì˜ì—­ì„ ë¹ ë¥´ê²Œ íšŒìˆ˜í•˜ì—¬ ë¹ˆ ê³µê°„ì„ í™•ë³´í•˜ë¯€ë¡œ GC ë¹ˆë„ê°€ ì¤„ì–´ë“ ë‹¤

### ë‹¨ì 
- Minor GC, Major GCë¥¼ ìˆ˜í–‰í•˜ê³  ë‚˜ì„œë„ ì—¬ìœ  ê³µê°„ì´ ë¶€ì¡±í•œ ê³µê°„ ë¶€ì¡± ìƒíƒœë¥¼ ì¡°ì‹¬í•´ì•¼ í•œë‹¤
  - ì´ ë•ŒëŠ” Full GCê°€ ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ë™ìž‘í•œë‹¤
- Humonogous ì˜ì—­ì€ ì œëŒ€ë¡œ ìµœì í™”ë˜ì§€ ì•ŠëŠ” ì˜ì—­ì´ë¼ ì´ ì˜ì—­ì´ ë§Žìœ¼ë©´ ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤

## Z GC
- Regionì„ `ZPage`ë¡œ ì •ì˜í•˜ì—¬ ì‚¬ìš©í•œë‹¤
- `ZPage` ëŠ” ë™ì ìœ¼ë¡œ ìƒì„± / ì‚­ì œëœë‹¤
- ì¼ë°˜ì ìœ¼ë¡œ GCê°€ ìˆ˜í–‰ë˜ë©´ ì‚´ì•„ìžˆëŠ” ê°ì²´ë¥¼ ì´ë™ì‹œí‚¤ëŠ”ë°, ì´ ë•Œ ê°ì²´ë¥¼ ì´ë™í•˜ê¸° ìœ„í•´ ë¹ˆ ê³µê°„ì„ ì°¾ëŠ” ì—°ì‚°ì´ ìƒˆë¡œìš´ ì˜ì—­ì„ í• ë‹¹í•´ì„œ ì±„ìš°ëŠ” ê²ƒë³´ë‹¤ ë¹„ìš©ì´ ë” ë§Žì´ ë“ ë‹¤ !
- ê·¸ëž˜ì„œ, ZGCì—ì„œëŠ” compact ê³¼ì •ì—ì„œ ê¸°ì¡´ regionì˜ ë¹ˆ ê³³ì„ ì°¾ì•„ì„œ ê°ì²´ë¥¼ ë„£ëŠ” ê²ƒì´ ì•„ë‹Œ ìƒˆë¡œìš´ regionì„ ìƒì„±í•˜ì—¬ ì‚´ì•„ìžˆëŠ” ê°ì²´ë¥¼ ì±„ìš´ë‹¤

> ### Java 8ì˜ Default GC
> - Parallel GC
> ### Java 11ì˜ Default GC
> - G1 GC

## Reference 
- https://d2.naver.com/helloworld/1329
- https://www.baeldung.com/jvm-garbage-collectors
- https://www.blog-dreamus.com/post/zgc%EC%97%90-%EB%8C%80%ED%95%B4%EC%84%9C
- https://steady-coding.tistory.com/590
- https://www.youtube.com/watch?v=FMUpVA0Vvjw
