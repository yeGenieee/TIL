# 2023-07-27

### ğŸ“Œ í•™ìŠµ ëª©í‘œ
- Interceptorë€

### âœï¸ TIL
- Interceptorë€
- Interceptorë¥¼ ì™œ ì“¸ê¹Œ?
- Interceptorì˜ ì‚¬ìš© ë°©ë²•

## Interceptor
- Spring ë²”ìœ„ ë‚´, Dispatcher Servletì´ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ê³¼ í›„ì— ìš”ì²­ì„ ì°¸ì¡°í•˜ê±°ë‚˜ ê°€ê³µí•˜ê¸° ìœ„í•œ ê¸°ëŠ¥
- HttpRequest (ìš”ì²­)ê³¼ HttpResponse (ì‘ë‹µ)ì„ ê°€ë¡œì±„ì„œ ì›í•˜ëŠ” ë™ì‘ì„ ì¶”ê°€í•˜ëŠ” ì—­í• ì„ í•œë‹¤

## íŠ¹ì§•
- ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆì–´ì„œ ì¦‰, ìŠ¤í”„ë§ì—ì„œ ê´€ë¦¬ë˜ê¸°ì— ìŠ¤í”„ë§ ë‚´ë¶€ ì œê³µ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤
- ìŠ¤í”„ë§ ë‚´ì˜ ëª¨ë“  ê°ì²´ (Bean)ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤
- DispatcherServeletì´ ì‹¤í–‰ëœ í›„ì— í˜¸ì¶œëœë‹¤

## Interceptorë¥¼ ì™œ ì“¸ê¹Œ?
- Interceptorê°€ ì—†ë‹¤ë©´, ê³µí†µ ë¡œì§ì„ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ë§ˆë‹¤ ìš”ì²­, ì‘ë‹µì— ëŒ€í•´ í•¸ë“¤ë§í•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•´ì•¼ í•œë‹¤ --> ğŸ¥² êµ‰ì¥íˆ ë¹„íš¨ìœ¨ì 

- Intercpetorê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ ì•Œì•„ë³´ê¸° ì „ì—, `HandlerMapping` ì— ëŒ€í•´ ì•Œì•„ë³´ì

## HandlerMapping
### ëª©ì 
- URLì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í•¸ë“¤ëŸ¬ ë©”ì†Œë“œì— ë§¤í•‘í•˜ëŠ” ê²ƒ
- `DispatcherServlet` ì´ ìš”ì²­ì„ ì²˜ë¦¬í•  ë•Œ,  `HandlerMapping` ì„ ì‹¤í–‰í•œë‹¤
- ë” ì •í™•í•˜ê²ŒëŠ”, `HandlerAdapter` ë¥¼ ì´ìš©í•´ì„œ `DispatcherServlet` ì´ ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤

##  Interceptorì˜ ì‚¬ìš© ë°©ë²•
- Spring InterceptorëŠ” `HandlerInterceptorAdapter` í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ê±°ë‚˜, `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©´ ëœë‹¤

- `spring-web` ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê³ , 
-  `org.springframework.web.servlet` ì˜ `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©´ ëœë‹¤
```java
public interface HandlerInterceptor {
	default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
		return true;
	}

	default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception {
	}

	default void afterCompletion(HttpServletRequest request, HttpServeltResponse response, Object handler, @Nullable Exception ex) throws Exception {
	}
}
```

### Interceptorì˜ ì£¼ìš” ë©”ì†Œë“œ
1. preHandle
2. postHandle
3. afterCompletion

### 1. preHandle
- ì‹¤ì œ í•¸ë“¤ëŸ¬ ì‹¤í–‰ ì „ì— í˜¸ì¶œë˜ëŠ” ë©”ì†Œë“œ
- boolean ê°’ì„ ë¦¬í„´í•´ì•¼ í•œë‹¤
- ì—¬ê¸°ì„œ ë¦¬í„´í•˜ëŠ” boolean ê°’ì€ execution chainì˜ ì²˜ë¦¬ë¥¼ ê²Œì†í•  ê²ƒì¸ì§€ ì•„ë‹ˆë©´ ë©ˆì¶œ ê²ƒì¸ì§€ì— ëŒ€í•œ ê°’ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤
- `true`  : handler execution chainì´ ê³„ì† ì‹¤í–‰ëœë‹¤
-  `false`  : `DispatcherServlet` ì´ ìœ ì…ë˜ëŠ” ìš”ì²­ì— ëŒ€í•´ ì¸í„°ì…‰í„°ê°€ ì•Œì•„ì„œ ì²˜ë¦¬í–ˆë‹¤ê³  ê°€ì •í•˜ê³ , execution chain ë‚´ ë‹¤ë¥¸ interceptorì™€ í•¸ë“¤ëŸ¬ë¥¼ ë” ì´ìƒ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤

### 2. postHandle
- í•¸ë“¤ëŸ¬ ì‹¤í–‰ í›„ì— í˜¸ì¶œë˜ëŠ” ë©”ì†Œë“œ
- Controller í•˜ìœ„ ê³„ì¸µì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ `postHandle` ì€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤

### 3. afterCompletion
- ìš”ì²­ì´ ì²˜ë¦¬ë˜ê³ , viewê°€ ìƒì„±ë˜ì—ˆì„ ë•Œ (ë·°ì—ì„œ ìµœì¢… ê²°ê³¼ë¥¼ ìƒì„±í•˜ëŠ” ì¼ì„ í¬í•¨í•˜ì—¬ ì‘ì—…ì´ ì™„ë£Œëœ í›„ì— í˜¸ì¶œë˜ëŠ” ë©”ì†Œë“œ
- ìš”ì²­ ì²˜ë¦¬ ì¤‘ì— ì‚¬ìš©í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•  ë•Œ ì‚¬ìš©í•˜ê¸° ì í•©í•˜ë‹¤
- Controller í•˜ìœ„ ê³„ì¸µì—ì„œ ì‘ì—…ì„ ì§„í–‰í•˜ë‹¤ê°€ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë”ë¼ë„ afterCompletionì€ ë°˜ë“œì‹œ í˜¸ì¶œëœë‹¤


## Spring MVCì—ì„œ Interceptorì˜ ì„¤ì • ë°©ë²•
- `WebMvcConfigurer` ë¥¼ êµ¬í˜„í•œ   `WebConfig`  í´ë˜ìŠ¤ì— í•´ë‹¹ í´ë˜ìŠ¤ì— ì„¤ì •í•˜ëŠ” ë°©ë²•
```java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurere {
	
	@Override
	public void addInterceptors(InterceptorRegistry registry) {
		registry.addInterceptor(new LocaleChangeInterceptor());
		registry.addInterceptor(new ThemeChangeInterceptor()).addPathPatterns("/**").excludePathPatterns("/admin/**");
	}
}
```

- `XML` ì„¤ì • íŒŒì¼ì— ì„¤ì •í•˜ëŠ” ë°©ë²•
```java
<mvc:interceptors>
	<bean class="org.springframework.web.servlet.i18n.LocaleChangeInterceptor"/>
	<mvc:interceptor>
		<mvc:mapping path="/**"/>
		<mvc:exclude-mapping path="/admin/**"/>
		<bean class="org.springframework.web.servlet.theme.ThemeChangeInterceptor"/>
	</mvc:interceptor>
</mvc:interceptors>
```


## Reference 
- https://www.baeldung.com/spring-mvc-handlerinterceptor
- https://gngsn.tistory.com/153
- https://mangkyu.tistory.com/173
