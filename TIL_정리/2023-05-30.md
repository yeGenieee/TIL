# 2023-05-30

### π“ ν•™μµ κ³„ν
- JVM HotSpot VM JIT Compiler
- Garbage Collection

### βοΈ TIL
- JVM HotSpot VM JIT Compiler
- Garbage Collection

## JVM HotSpot VM
- μλ°”λ¥Ό λ§λ“  Sun μ—μ„λ” μλ°”μ μ„±λ¥μ„ κ°μ„ ν•κΈ° μ„ν•΄μ„ JIT μ»΄νμΌλ¬λ¥Ό λ§λ“¤λ©΄μ„ κ·Έ μ΄λ¦„μ„ HotSpot μΌλ΅ λ…λ…ν–λ‹¤
- μ΄ HotSpotμ€ Java 1.3 λ¶€ν„° κΈ°λ³Έ VMμΌλ΅ μ‚¬μ©λμ–΄ μ™”κΈ° λ•λ¬Έμ— μ§€κΈ μ΄μλκ³  μλ” λ€λ¶€λ¶„μ μ‹μ¤ν…λ“¤μ€ λ¨λ‘ HotSpot κΈ°λ°μ VMμ΄λ‹¤

### HotSpot VMμ μ£Όμ” μ»΄ν¬λ„νΈ
1. VM (Virtual Machine) λ°νƒ€μ„
2. JIT (Just-In-time) μ»΄νμΌλ¬
3. λ©”λ¨λ¦¬ κ΄€λ¦¬μ

### HotSpot VM μ•„ν‚¤ν…μ²
![HotSpotVM_architecture](image/HotSpotVM_architecture.png)
- λ κ³ μ²λΌ HotSpot VM λ°νƒ€μ„μ— `GC λ°©μ‹`κ³Ό `JIT μ»΄νμΌλ¬`λ¥Ό λΌμ› λ§μ¶° μ‚¬μ©ν•  μ μλ‹¤

## JIT Optimizer
- μΌλ‹¨, HotSpot μ»΄νμΌλ¬λ” `Server` / `Client` λ²„μ „μ μ»΄νμΌλ¬λ΅ λ‚λ‰λ‹¤
- `Server Compiler` : μ–΄ν”λ¦¬μΌ€μ΄μ… μν–‰ μ†λ„μ— μ΄μ μ΄ λ§μ¶”μ–΄μ Έ μλ‹¤
- `Client Compiler` : CPU μ½”μ–΄κ°€ ν•λ‚λΏμΈ μ‚¬μ©μλ¥Ό μ„ν•΄μ„ λ§λ“¤μ–΄μ§„ μ»΄νμΌλ¬λ΅, μ–΄ν”λ¦¬μΌ€μ΄μ… μ‹μ‘ μ‹κ°„μ„ λΉ λ¥΄κ² ν•κ³ , μ μ€ λ©”λ¨λ¦¬λ¥Ό μ μ ν•κ² ν•λ‹¤

- JIT μ»΄νμΌλ¬λ” μ–΄ν”λ¦¬μΌ€μ΄μ…μ—μ„ κ°κ°μ λ©”μ„λ“λ¥Ό μ»΄νμΌ ν•  λ§νΌμ μ‹κ°„μ  μ—¬μ λ” μ—†λ‹¤
- κ·Έλμ„, λ¨λ“  μ½”λ“λ” μ΄κΈ°μ— μΈν„°ν”„λ¦¬ν„°μ— μν•΄ μ‹μ‘λκ³ , ν•΄λ‹Ή μ½”λ“κ°€ μ¶©λ¶„ν λ§μ΄ μ‚¬μ©λ  κ²½μ°μ—λ§ μ»΄νμΌ ν•  λ€μƒμ΄ λλ‹¤

### μ¶©λ¶„ν λ§μ΄ μ‚¬μ©λλ‹¤λ” κ²ƒμ„ μ–΄λ–»κ² μ•„λ”κ°€?
- HotSpot VMμ—μ„λ” κ° λ©”μ„λ“μ— μλ” `counter` λ¥Ό ν†µν•΄μ„ ν†µμ λκ³ , λ©”μ„λ“μ—λ” 2κ°€μ§€ μΉ΄μ΄ν„°λ¥Ό λ‘”λ‹¤
  1. μν–‰ μΉ΄μ΄ν„° (invocation counter) : λ©”μ„λ“λ¥Ό μ‹μ‘ν•  λ• λ§λ‹¤ μ¦κ°€ν•λ” κ°’
  2. λ°±μ—μ§€ μΉ΄μ΄ν„° (backedge counter) : λ†’μ€ λ°”μ΄νΈ μ½”λ“ μΈλ±μ¤μ—μ„ λ‚®μ€ μΈλ±μ¤ μ»¨νΈλ΅¤ νλ¦„μ΄ λ³€κ²½λ  λ•λ§λ‹¤ μ¦κ°€ν•λ” κ°’, **λ©”μ„λ“κ°€ λ£¨ν”„κ°€ μ΅΄μ¬ν•λ”μ§€ ν™•μΈν•  λ• μ‚¬μ©λλ” κ°’** μ΄λΌκ³  μΌλ‹¨ μ•μ•„λ‘μ (μν–‰ μΉ΄μ΄ν„°λ³΄λ‹¤ μ»΄νμΌ μ°μ„  μμ„κ°€ λ†’λ‹¤)

- μ„μ λ‘ μΉ΄μ΄ν„°λ“¤μ€ **μΈν„°ν”„λ¦¬ν„°**μ— μν•΄μ„ μ¦κ°€λ  λ•λ§λ‹¤, κ·Έ κ°’λ“¤μ΄ κ° κ°’λ“¤μ΄ μ‚¬μ©ν•λ” **ν•κ³„μΉ**μ— λ„λ‹¬ν–λ”μ§€ ν™•μΈν•λ‹¤
- λ„λ‹¬ν–μ„ κ²½μ°μ—λ” μΈν„°ν”„λ¦¬ν„°κ°€ **μ»΄νμΌμ„ μ”μ²­**ν•λ‹¤

#### κ° μΉ΄μ΄ν„°κ°€ μ‚¬μ©ν•λ” ν•κ³„μΉ
- `CompileThreshold` : μν–‰ μΉ΄μ΄ν„°κ°€ μ‚¬μ©ν•λ” ν•κ³„μΉ
- `CompileThreshold * OnStackReplacePercentage / 100`: λ°±μ—μ§€ μΉ΄μ΄ν„°κ°€ μ‚¬μ©ν•λ” ν•κ³„μΉ

> κ° ν•κ³„μΉ κ°’λ“¤μ€ JVMμ΄ μ‹μ‘ν•  λ• μ§€μ •κ°€λ¥ν•λ‹¤
> μ‹μ‘ μµμ…μ— μ¤„ μ μλ‹¤
> `XX:CompileThreshold=35000`
> `XX:OnStackReplacePercentage=80`
> μ΄λ ‡κ² λλ©΄, λ©”μ„λ“κ°€ 35000λ² νΈμ¶λ  λ• JITμ—μ„ μ»΄νμΌμ„ ν•κ³ , λ°±μ—μ§€ μΉ΄μ΄ν„°κ°€ 35000 * 80 = 28000μ΄ λμ—μ„ λ• μ»΄νμΌ λλ‹¤

### μΈν„°ν”„λ¦¬ν„°κ°€ JIT μ»΄νμΌλ¬μ—κ² μ»΄νμΌ μ”μ²­ ν›„ κ³Όμ •
- μΈν„°ν”„λ¦¬ν„°μ— μν•΄ μ¦κ°€λ μΉ΄μ΄ν„°κ°€ ν•κ³„μΉμ— λ„λ‹¬ν•λ©΄, μΈν„°ν”„λ¦¬ν„°λ” μ»΄νμΌμ„ μ”μ²­ν•λ‹¤ 
1. μ»΄νμΌμ΄ μ”μ²­λλ©΄ μ»΄νμΌ λ€μƒ λ©λ΅ νμ— μ“μΈλ‹¤
   - ν•λ‚ μ΄μƒμ μ»΄νμΌλ¬ μ¤λ λ“κ°€ μ΄ νλ¥Ό λ¨λ‹ν„°λ§ν•λ”λ°, μ»΄νμΌλ¬ μ¤λ λ“κ°€ λ°”μμ§€ μ•μ„ λ• νμ—μ„ λ€μƒμ„ λΉΌλ‚΄μ„ μ»΄νμΌμ„ μ‹μ‘ν•λ‹¤
   ##### μΈν„°ν”„λ¦¬ν„°λ” μ»΄νμΌμ΄ μΆ…λ£λκΈ°λ¥Ό κΈ°λ‹¤λ¦¬μ§€ μ•κ³ , μν–‰ μΉ΄μ΄ν„°λ¥Ό λ¦¬μ…‹ν•κ³  μΈν„°ν”„λ¦¬ν„°μ—μ„ λ©”μ„λ“ μν–‰μ„ κ²μ† ν•λ‹¤
2. μ»΄νμΌ μΆ…λ£ μ‹, μ»΄νμΌλ μ½”λ“μ™€ λ©”μ„λ“κ°€ μ—°κ²°λλ‹¤
3. μ΄μ  μ΄ μ΄ν›„λ¶€ν„°λ” λ©”μ„λ“κ°€ νΈμ¶λλ©΄ μ»΄νμΌ λ μ½”λ“λ¥Ό μ‚¬μ©ν•κ² λλ‹¤

## HotSpot VMμ OSR(On Stack Replacement) Compile
- μΈν„°ν”„λ¦¬ν„°μ—μ„ μν–‰ν• μ½”λ“ μ¤‘ μ¤λ«λ™μ• λ£¨ν”„κ°€ μ§€μ†λλ” κ²½μ°μ— μ‚¬μ©λλ‹¤
- λ§μ•½, ν•΄λ‹Ή μ½”λ“μ μ»΄νμΌμ΄ μ™„λ£λ μƒνƒμ—μ„ μµμ ν™” λμ§€ μ•μ€ μ½”λ“κ°€ μν–‰λκ³  μλ” κ²ƒμ„ λ°κ²¬ν• κ²½μ° 
  - μΈν„°ν”„λ¦¬ν„°μ— κ³„μ† λ¨Έλ¬΄λ¥΄μ§€ μ•κ³  -> μ»΄νμΌ λ μ½”λ“λ΅ λ³€κ²½ν•λ‹¤

- μΈν„°ν”„λ¦¬ν„°μ—μ„ μ‹μ‘λ μ¤λ«λ™μ• μ§€μ†λλ” λ£¨ν”„κ°€ λ‹¤μ‹λ” λ¶λ¦¬μ§€ μ•μ„ κ²½μ°μ—λ” λ„μ›€μ΄ μ•λλ‹¤
  - κ·Έλ ‡μ§€λ§, λ£¨ν”„κ°€ λλ‚μ§€ μ•κ³  μ§€μ†μ μΌλ΅ μν–‰λκ³  μμ„ κ²½μ°μ—λ” λ„μ›€μ΄ λλ‹¤!

## Garbage Collector
- JVM λ°νƒ€μ„ λ°μ΄ν„° μμ—­ λ‚΄ Heap μμ—­μ κ°μ²΄λ¥Ό κ΄€λ¦¬ν•΄μ£Όλ” κ²ƒ

### Garbage Collectorμ μ—­ν• 
1. λ©”λ¨λ¦¬ ν• λ‹Ή
2. μ‚¬μ©μ¤‘μΈ λ©”λ¨λ¦¬ μΈμ‹
3. μ‚¬μ©ν•μ§€ μ•λ” λ©”λ¨λ¦¬ μΈμ‹
   - μ΄κ±΄ κµ³μ΄ μ™ ν• κΉ?
     - μ‚¬μ©ν•μ§€ μ•λ” λ©”λ¨λ¦¬λ¥Ό μΈμ‹ν•μ§€ μ•μΌλ©΄, ν• λ‹Ήν• λ©”λ¨λ¦¬ μμ—­μ΄ κ½‰ μ°¨μ„ JVM ν–‰μ΄ κ±Έλ¦¬κ±°λ‚ λ” λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήν•λ ¤λ” ν„μƒμ΄ λ°μƒν•κΈ° λ•λ¬Έμ΄λ‹¤

### Garbage Collectorκ°€ μΈμ‹ν•κ³  ν• λ‹Ήν•λ” μλ°”μ Heap μμ—­
![Heap_μμ—­](https://journaldev.nyc3.digitaloceanspaces.com/2014/05/Java-Memory-Model-450x186.png)

*μ¶μ² : https://www.digitalocean.com/community/tutorials/java-jvm-memory-model-memory-management-in-java*

### Young μμ—­
1. Eden
2. Survivor 1
3. Survivor 2

- λ©”λ¨λ¦¬μ— κ°μ²΄κ°€ μƒμ„±λλ©΄, `Eden` μμ—­μ— κ°μ²΄κ°€ μƒμ„±λλ‹¤
- `Eden` μμ—­μ΄ κ½‰ μ°¨λ©΄, μ‚΄μ•„μλ” κ°μ²΄λ§ `Survivor` μμ—­μΌλ΅ λ³µμ‚¬λλ‹¤ (Eden μμ—­μ— μλ κ°μ²΄κ°€ μ–΄λ””λ΅ κ°€ μ®κ²¨μ§€κ±°λ‚ μ‚­μ λμ–΄μ•Ό ν•λ―€λ΅)
- λ‘ κ°μ Survivor μμ—­ μ¤‘ ν•λ‚λ” λ°λ“μ‹ λΉ„μ–΄μμ–΄μ•Ό ν•λ‹¤
  - λ‘ μ¤‘ λΉ„μ–΄μλ” μμ—­μΌλ΅ Eden μμ—­μ— μλ κ°μ²΄ μ¤‘ GC ν›„μ— μ‚΄μ•„ λ‚¨μ•„μλ” κ°μ²΄λ“¤μ΄ μ΄λ™ν•λ‹¤
- ν• λ‹Ήλ Survivor μμ—­μ΄ κ°€λ“ μ°¨λ©΄, GCκ°€ λλ©΄μ„ Eden μμ—­μ— μλ” κ°μ²΄μ™€ κ½‰ μ°¬ Survivor μμ—­μ— μλ” κ°μ²΄κ°€ λΉ„μ–΄μλ” Survivor μμ—­μΌλ΅ μ΄λ™ν•λ‹¤
- μ΄λ ‡κ² Survivor 1 , 2λ¥Ό μ™”λ‹¤κ°”λ‹¤ ν•λ κ°μ²΄λ“¤μ€ `Old` μμ—­μΌλ΅ μ΄λ™ν•λ‹¤
=> `Minor GC`, `Young GC`

### Old μμ—­
1. λ©”λ¨λ¦¬ μμ—­

- Young μμ—­μ—μ„ Survivor μμ—­μ„ κ±°μΉμ§€ μ•κ³  λ°”λ΅ Old μμ—­μΌλ΅ μ΄λ™ν•λ” κ°μ²΄κ°€ μλ”λ°,
  - κ°μ²΄μ ν¬κΈ°κ°€ μ•„μ£Ό ν° κ²½μ°μ— λ°”λ΅ Old μμ—­μΌλ΅ μ΄λ™ν•κ² λλ‹¤

- λ§μ•½, μ¤λ μ‚΄μ•„μλ” κ°μ²΄λ“¤μ€ Old μμ—­μΌλ΅ μ΄λ™ν•κ² λλ”λ°, μ§€μ†μ μΌλ΅ μ΄λ™ν•λ‹¤κ°€ Old μμ—­μ΄ κ°€λ“μ°¨λ©΄ GCκ°€ λ°μƒν•λ‹¤
  - `Major GC`, `Full GC` (Old μμ—­μ΄λ‚ Perm μμ—­μ—μ„ λ°μƒν•λ” GC)
